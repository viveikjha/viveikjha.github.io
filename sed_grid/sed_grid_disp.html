<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SED Grid Plot with Filters</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.min.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #f8f9fa;
            color: #333;
        }
        #main-container {
            display: flex;
            height: 100vh;
        }
        #left-panel {
            width: 380px;
            flex-shrink: 0;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #right-panel {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        #plot { 
            width: 100%; 
            flex-grow: 1; /* Make plot fill available space */
        }
        #param-values { 
            background-color: #f4f4f4; 
            padding: 15px; 
            border-radius: 8px; 
        }
        #param-values span { font-weight: bold; }
        .about-btn, .upload-btn {
            display: block;
            width: 100%;
            padding: 10px 24px;
            font-size: 1em;
            cursor: pointer;
            background: linear-gradient(90deg, #00796B 0%, #4DB6AC 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,128,128,0.15);
            transition: background 0.2s, transform 0.1s;
            text-align: center;
            box-sizing: border-box;
        }
        .about-btn:hover, .upload-btn:hover {
            background: linear-gradient(90deg, #4DB6AC 0%, #00796B 100%);
            transform: translateY(-2px) scale(1.02);
        }
        #controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f7fdfd;
            border-radius: 8px;
            padding: 16px 18px 10px 18px;
            box-shadow: 0 1px 6px rgba(0,128,128,0.07);
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-container label {
            font-weight: 600;
            color: #2a3b5c;
            min-width: 70px; /* Align labels */
        }
        .slider-container input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #e0f2f1;
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }
        .slider-container input[type="range"]:hover {
            opacity: 1;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #009688;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 150, 136, 0.5);
        }
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #009688;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        .slider-value {
            font-weight: bold;
            color: #009688;
            min-width: 40px; /* Align values */
            text-align: right;
        }
        #param-values {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(0,128,128,0.07);
        }
        #param-values span { font-weight: bold; }
        #aux-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #csv-info-box {
            width: 100%;
            font-size: 0.9em;
            color: #2a3b5c;
        }
        #csv-info-box summary {
            cursor: pointer;
            font-weight: bold;
            padding: 10px 15px;
            background-color: #fdfdfd;
            border: 1px solid #b2dfdb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,128,128,0.1);
            list-style: none; /* Hide default marker */
            text-align: center;
        }
        #csv-info-box summary::-webkit-details-marker { display: none; } /* For Chrome/Safari */
        #csv-info-box .details-content {
            padding: 15px;
            margin-top: -5px; /* Overlap with summary border */
            background-color: #fdfdfd;
            border: 1px solid #b2dfdb;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        #csv-info-box .info-link {
            text-decoration: none;
            color: #fff;
            background-color: #00796B;
            padding: 8px 15px;
            border-radius: 5px;
            display: block; /* Make it a block to fill width */
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }
        #csv-info-box .info-link:hover {
            background-color: #00695C;
            transform: translateY(-1px);
        }
        footer {
            text-align: center;
            padding: 10px 0;
            margin-top: auto; /* Pushes footer to the bottom of the flex container */
            font-size: 0.9em;
        }
        footer a {
            color: #009688;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="left-panel">
            <h3>Controls</h3>
            <div id="controls"></div>
            <div id="param-values"></div>
            <div id="aux-controls">
                <a href="index.html" target="_blank" style="text-decoration: none;">
                    <button class="about-btn">About</button>
                </a>
                <label for="photometry-upload" class="upload-btn">Upload Photometry (CSV)</label>
                <input type="file" id="photometry-upload" accept=".csv" style="display: none;">
                
                <label for="clear-photometry-checkbox" style="cursor:pointer; color: #2a3b5c; font-size: 0.9em; text-align: center;">
                    <input type="checkbox" id="clear-photometry-checkbox" style="vertical-align: middle;">
                    Clear Photometry
                </label>

                <details id="csv-info-box">
                    <summary>CSV File Format</summary>
                    <div class="details-content">
                        <p>The uploaded CSV file should contain three columns (no header):</p>
                        <ul style="margin-top: 5px; margin-bottom: 15px; padding-left: 20px;">
                            <li>Wavelength [Å]</li>
                            <li>Flux</li>
                            <li>Flux Error</li>
                        </ul>
                        <a href="https://viveikjha.github.io/sed_grid/demo_flux.csv" download="demo_flux.csv" class="info-link">Download Demo CSV</a>
                    </div>
                </details>
            </div>
            <footer>
                <p>Developed and Maintained by <a href="https://viveikjha.github.io" target="_blank" rel="noopener noreferrer">Vivek Kumar Jha</a></p>
            </footer>
        </div>
        <div id="right-panel">
            <h2 style="margin: 0 0 20px 0;">SEDs generated by Prospector based on an initial parameter grid</h2>
            <div id="plot"></div>
        </div>
    </div>

    <script>
    const paramKeys = ['tage', 'logzsol', 'dust2', 'imf_type', 'mass', 'sfh', 'tau'];
    let allData = [];
    let currentFilteredSEDs = [];
    let photometryData = null;

    const fixedValues = {
        tage: [0.1, 1.0, 5.0, 10.0],
        logzsol: [-1.5, -0.5, 0.0, 0.3],
        dust2: [0.0, 0.5, 1.5, 3.0],
        imf_type: [1, 2, 3],
        mass: [8.0, 9.0, 10.0, 11.0],
        sfh: [1],
        tau: [0.1, 1.0, 5.0, 10.0]
    };

    fetch('https://raw.githubusercontent.com/viveikjha/viveikjha.github.io/main/sed_grid_large.json.gz')
        .then(res => res.arrayBuffer())
        .then(buf => {
            const decompressed = fflate.decompressSync(new Uint8Array(buf));
            const jsonStr = new TextDecoder().decode(decompressed);
            allData = JSON.parse(jsonStr);

            if (!Array.isArray(allData) || allData.length === 0) {
                console.error("Fetched SED data is not a non-empty array.", allData);
                allData = [];
                updatePlot([]);
                document.getElementById('param-values').innerHTML = '<p><b>Error: SED data could not be loaded or is empty.</b></p>';
                return;
            }

            setupUI();
            applyFilters(); // Apply initial filter to show one SED
        })
        .catch(err => {
            console.error("Failed to load or parse SED data:", err);
        });

    function setupUI() {
        const container = document.getElementById('controls');
        container.innerHTML = '';

        paramKeys.forEach(key => {
            const controlContainer = document.createElement('div');
            controlContainer.className = 'slider-container';

            const label = document.createElement('label');
            label.textContent = `${key}:`;
            label.htmlFor = `filter-${key}`;

            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = `filter-${key}`;
            slider.min = 0;
            slider.max = fixedValues[key].length - 1;
            slider.step = 1;
            slider.value = 0; // Start at the first value

            const valueSpan = document.createElement('span');
            valueSpan.id = `value-${key}`;
            valueSpan.className = 'slider-value';
            valueSpan.textContent = fixedValues[key][0];

            slider.addEventListener('input', () => {
                const selectedValue = fixedValues[key][slider.value];
                valueSpan.textContent = selectedValue;
                applyFilters();
            });

            controlContainer.appendChild(label);
            controlContainer.appendChild(slider);
            controlContainer.appendChild(valueSpan);
            container.appendChild(controlContainer);
        });

        // Add "Plot all" checkbox
        const plotAllContainer = document.createElement('div');
        plotAllContainer.style.paddingTop = '10px';
        plotAllContainer.innerHTML = `
            <label for="plot-all-checkbox" style="cursor:pointer; font-weight:bold; color: #2a3b5c;">
                <input type="checkbox" id="plot-all-checkbox" style="vertical-align: middle;">
                Plot multiple SEDs
            </label>
        `;
        container.appendChild(plotAllContainer);
        document.getElementById('plot-all-checkbox').addEventListener('change', handlePlotAllToggle);

        document.getElementById('clear-photometry-checkbox').addEventListener('change', handleClearPhotometry);
        document.getElementById('photometry-upload').addEventListener('change', handleFileUpload);
    }

    function getRandomSample(arr, n) {
        const result = new Array(n);
        let len = arr.length;
        const taken = new Array(len);
        if (n > len) {
            console.warn("getRandomSample: more elements taken than available. Returning all elements.");
            return [...arr];
        }
        while (n--) {
            const x = Math.floor(Math.random() * len);
            result[n] = arr[x in taken ? taken[x] : x];
            taken[x] = --len in taken ? taken[len] : len;
        }
        return result;
    }

    function handlePlotAllToggle(event) {
        const isChecked = event.target.checked;
        const sliders = paramKeys.map(key => document.getElementById(`filter-${key}`));

        if (isChecked) {
            sliders.forEach(slider => slider.disabled = true);
            const sampleSize = 200;
            const sampledSEDs = getRandomSample(allData, Math.min(sampleSize, allData.length));
            currentFilteredSEDs = sampledSEDs;
            updatePlot(sampledSEDs);
            displaySelectedParams({}, false, true, sampledSEDs.length);
        } else {
            sliders.forEach(slider => slider.disabled = false);
            applyFilters();
        }
    }

    function handleClearPhotometry(event) {
        if (event.target.checked) {
            photometryData = null;
            document.getElementById('photometry-upload').value = ''; // Reset file input
            updatePlot(currentFilteredSEDs);
            event.target.checked = false; // Uncheck after clearing
        }
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            try {
                const rows = text.trim().split('\n');
                const data = rows.map(row => row.split(',').map(parseFloat));

                photometryData = {
                    x: data.map(r => r[0]),
                    y: data.map(r => r[1]),
                    error_y: { type: 'data', array: data.map(r => r[2]), visible: true }
                };
                updatePlot(currentFilteredSEDs);
            } catch (err) {
                console.error("Error parsing CSV file:", err);
                alert("Could not parse CSV file. Please ensure it has 3 columns (without headers): wavelength, flux, fluxerr.");
                photometryData = null;
            }
        };
        reader.readAsText(file);
    }

    function applyFilters() {
        if (document.getElementById('plot-all-checkbox')?.checked) {
            handlePlotAllToggle({ target: { checked: true } });
            return;
        }

        let filtered = allData;
        const selectedParams = {};

        paramKeys.forEach(key => {
            const slider = document.getElementById(`filter-${key}`);
            const selectedValue = fixedValues[key][slider.value];
            selectedParams[key] = selectedValue;
            if (fixedValues[key].length > 1) {
                filtered = filtered.filter(d => {
                    const paramVal = d.params[key];
                    return Math.abs(selectedValue - parseFloat(paramVal)) < 1e-4;
                });
            }
        });
        
        if (filtered.length === 0) {
            // If no exact match, show a random one instead of nothing
            const randomIndex = Math.floor(Math.random() * allData.length);
            currentFilteredSEDs = [allData[randomIndex]];
            updatePlot(currentFilteredSEDs);
            displaySelectedParams(currentFilteredSEDs[0].params, true); // Indicate it's not an exact match
        } else {
            currentFilteredSEDs = filtered.slice(0, 1);
            updatePlot(currentFilteredSEDs);
            displaySelectedParams(currentFilteredSEDs[0].params);
        }
    }

    function updatePlot(sedEntries) {
        const traces = [];
        const isPlottingAll = document.getElementById('plot-all-checkbox')?.checked;

        if (sedEntries.length > 0) {
            sedEntries.forEach((entry, index) => {
                let color;
                if (isPlottingAll) {
                    const hue = (index * (360 / sedEntries.length)) % 360;
                    color = `hsla(${hue}, 80%, 50%, 0.3)`;
                } else {
                    color = '#009688';
                }

                traces.push({
                    x: entry['wavelength'],
                    y: entry['flux'],
                    mode: 'lines',
                    line: { 
                        shape: 'hv',
                        color: color
                    },
                    type: 'scatter',
                    name: `Model SED ${index + 1}`,
                    showlegend: !isPlottingAll // Hide individual legends when plotting all
                });
            });
        }

        if (photometryData) {
            traces.push({
                ...photometryData,
                mode: 'markers',
                type: 'scatter',
                name: 'Uploaded Photometry',
                marker: { symbol: 'o', size: 10, color: 'rgba(255, 0, 0, 0.7)', line: { width: 1, color: 'black' } },
                showlegend: true
            });
        }

        const layout = {
            title: {
                text: isPlottingAll ? `Showing a random subset of ${sedEntries.length} SEDs` : (sedEntries.length > 0 ? `Showing 1 SED` : 'No SED to display'),
                y: 0.95
            },
            xaxis: { title: 'Wavelength [Å]', type: 'log', range: [3, 7] },
            yaxis: { title: 'Flux [erg s<sup>-1</sup> cm<sup>-2</sup> Å<sup>-1</sup>]', type: 'log' },
            margin: { t: 50, b: 50, l: 80, r: 30 },
            showlegend: true,
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: 1.02,
                xanchor: 'right',
                x: 1
            }
        };

        Plotly.newPlot('plot', traces, layout, { responsive: true });
    }

    function format(val) {
        return typeof val === 'number' ? val.toFixed(3) : val;
    }

    function displaySelectedParams(params, noMatch = false, allPlotted = false, count = 0) {
        const paramValuesDiv = document.getElementById('param-values');
        const paramUnits = {
            tage: 'Gyr',
            mass: 'log₁₀(M/M☉)',
            tau: 'Gyr'
        };

        if (allPlotted) {
            paramValuesDiv.innerHTML = `<p><b>Displaying a random subset of ${count} SEDs.</b> Sliders are disabled.</p>`;
            return;
        }
        if (noMatch) {
            paramValuesDiv.innerHTML = '<p><b>No matching SED found. Displaying a random one instead.</b></p>';
        } else {
            paramValuesDiv.innerHTML = '<p><b>Selected Parameters:</b></p>';
        }

        let htmlContent = paramValuesDiv.innerHTML;
        htmlContent += '<div style="white-space:pre; overflow-x:auto; line-height: 1.6;">';
        htmlContent += paramKeys
            .map(key => {
                const value = params[key];
                const unit = paramUnits[key] || '';
                const formattedValue = (typeof value === 'number' && key !== 'imf_type' && key !== 'sfh') ? value.toFixed(2) : value;
                return `<span>${key}:</span> ${formattedValue} ${unit}`;
            })
            .join('\n');
        htmlContent += '</div>';

        paramValuesDiv.innerHTML = htmlContent;
    }
    </script>
</body>
</html>
