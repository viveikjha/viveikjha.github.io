<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SED Grid Plot with Filters</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; }
        #controls { margin-bottom: 20px; }
        .dropdown { margin: 5px; }
        #plot { width: 100%; height: 60vh; }
        #param-values { background-color: #f4f4f4; padding: 15px; margin-top: 20px; border-radius: 8px; }
        #param-values span { font-weight: bold; }
    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <h2 style="margin: 0;">SEDs generated by Prospector based on an initial parameter grid</h2>
        <a href="intro.html" target="_blank" style="text-decoration: none;">
            <button class="about-btn">About</button>
        </a>
    </div>
    <div id="controls"></div>
    <div id="plot"></div>
    <div id="param-values"></div>

    <style>
        .about-btn {
            padding: 10px 24px;
            font-size: 1em;
            cursor: pointer;
            background: linear-gradient(90deg, #4f8cff 0%, #38e8ff 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(79,140,255,0.15);
            transition: background 0.2s, transform 0.1s;
        }
        .about-btn:hover {
            background: linear-gradient(90deg, #38e8ff 0%, #4f8cff 100%);
            transform: translateY(-2px) scale(1.04);
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 18px;
            align-items: center;
            background: #f8fbff;
            border-radius: 8px;
            padding: 16px 18px 10px 18px;
            box-shadow: 0 1px 6px rgba(79,140,255,0.07);
        }
        #controls label {
            font-weight: 600;
            margin-right: 4px;
            color: #2a3b5c;
        }
        .dropdown {
            padding: 7px 14px;
            border-radius: 5px;
            border: 1px solid #b8d0ff;
            background: #fff;
            font-size: 1em;
            color: #2a3b5c;
            transition: border 0.2s;
            box-shadow: 0 1px 3px rgba(79,140,255,0.04);
        }
        .dropdown:focus {
            border: 1.5px solid #4f8cff;
            outline: none;
        }
        #param-values {
            background-color: #f4f4f4;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(79,140,255,0.07);
        }
        #param-values span { font-weight: bold; }
    </style>

    <script>
    const paramKeys = ['tage', 'logzsol', 'dust2', 'imf_type', 'mass', 'sfh', 'tau'];
    let allData = [];

    // Use consistent typing
    const fixedValues = {
        tage: [0.1, 1.0, 5.0, 10.0],
        logzsol: [-1.5, -0.5, 0.0, 0.3],
        dust2: [0.0, 0.5, 1.5, 3.0],
        imf_type: [1, 2, 3], // stored as numbers
        mass: [8.0, 9.0, 10.0, 11.0],
        sfh: [1], // assuming numeric
        tau: [0.1, 1.0, 5.0, 10.0]
    };

    // Load and parse the gzipped JSON
    fetch('https://raw.githubusercontent.com/viveikjha/viveikjha.github.io/main/sed_grid_large.json.gz')

        .then(res => res.arrayBuffer())
        .then(buf => {
            const decompressed = fflate.decompressSync(new Uint8Array(buf));
            const jsonStr = new TextDecoder().decode(decompressed);
            allData = JSON.parse(jsonStr);

            setupUI();
            updatePlot(allData.slice(0, 5)); // show first 5 SEDs on load
        })
        .catch(err => {
            console.error("Failed to load or parse SED data:", err);
        });

    function setupUI() {
        const container = document.getElementById('controls');
        container.innerHTML = '';

        paramKeys.forEach(key => {
            const select = document.createElement('select');
            select.id = `filter-${key}`;
            select.className = 'dropdown';
            const label = document.createElement('label');
            label.textContent = `${key}: `;
            label.htmlFor = select.id;

            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All';
            select.appendChild(allOption);

            fixedValues[key].forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });

            select.addEventListener('change', applyFilters);

            container.appendChild(label);
            container.appendChild(select);
        });
    }

    function applyFilters() {
        let filtered = allData;

        paramKeys.forEach(key => {
            const rawVal = document.getElementById(`filter-${key}`).value;
            if (rawVal !== 'all') {
                const typedVal = typeof fixedValues[key][0] === 'number' ? parseFloat(rawVal) : rawVal;
                filtered = filtered.filter(d => {
                    const paramVal = d.params[key];
                    if (typeof typedVal === 'number') {
                        return Math.abs(typedVal - parseFloat(paramVal)) < 1e-4;
                    } else {
                        return paramVal == typedVal;
                    }
                });
            }
        });

        if (filtered.length > 0) {
            updatePlot(filtered);
            displaySelectedParams(filtered);
        } else {
            updatePlot([]);
            document.getElementById('param-values').innerHTML =
                '<p><b>No matching SEDs found for the selected parameters.</b></p>';
        }
    }

    function updatePlot(entries) {
        if (entries.length === 0) {
            Plotly.newPlot('plot', [], { title: 'No SEDs to display' });
            return;
        }

        const traces = entries.map(entry => {
            const wav = entry['wavelength'];
            const flux = entry['flux'];
            const label = paramKeys.map(k => `${k}: ${format(entry.params[k])}`).join(', ');

            return {
                x: wav,
                y: flux,
                mode: 'lines',
                line: { shape: 'hv' },
                type: 'scatter',
                name: label
            };
        });

        const layout = {
            title: `Showing ${entries.length} SED${entries.length > 1 ? 's' : ''}`,
            xaxis: { title: 'Wavelength [Ã…]', type: 'log' },
            yaxis: { title: 'Flux', type: 'log' },
            margin: { t: 30 },
            legend: { font: { size: 8 } }
        };

        Plotly.newPlot('plot', traces, layout, { responsive: true });
    }

    function format(val) {
        return typeof val === 'number' ? val.toFixed(3) : val;
    }

    function displaySelectedParams(filtered) {
        const paramValuesDiv = document.getElementById('param-values');
        if (filtered.length === 0) {
            paramValuesDiv.innerHTML = '<p><b>No matching SEDs found for the selected parameters.</b></p>';
            return;
        }

        const entry = filtered[0];
        let htmlContent = '<p><b>Selected Parameters:</b></p>';
        htmlContent += '<div style="white-space:pre;">';
        htmlContent += paramKeys.map(key => `${key}: ${format(entry.params[key])}`).join('\t');
        htmlContent += '</div>';

        paramValuesDiv.innerHTML = htmlContent;
    }
    </script>
</body>
</html>
