<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SED Grid Plot with Filters</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; padding-bottom: 100px; /* Add padding to bottom */ }
        #controls { margin-bottom: 20px; }
        .dropdown { margin: 5px; }
        #plot { width: 100%; height: 60vh; }
        #param-values { background-color: #f4f4f4; padding: 15px; margin-top: 20px; border-radius: 8px; }
        #param-values span { font-weight: bold; }
    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <h2 style="margin: 0;">SEDs generated by Prospector based on an initial parameter grid</h2>
    </div>
    <div id="controls"></div>
    <div id="plot"></div>
    <div id="param-values"></div>

    <div id="bottom-controls">
        <a href="intro.html" target="_blank" style="text-decoration: none;">
            <button class="about-btn">About</button>
        </a>
        <label for="photometry-upload" class="upload-btn">Upload Photometry (CSV)</label>
        <input type="file" id="photometry-upload" accept=".csv" style="display: none;">
        
        <details id="csv-info-box">
            <summary>CSV File Format</summary>
            <div class="details-content">
                <p>The uploaded CSV file should contain three columns (no header):</p>
                <ul style="margin-top: 5px; margin-bottom: 15px; padding-left: 20px;">
                    <li>Wavelength [Ã…]</li>
                    <li>Flux</li>
                    <li>Flux Error</li>
                </ul>
                <a href="https://viveikjha.github.io/demo_flux.csv" download="demo_flux.csv" class="info-link">Download Demo CSV</a>
            </div>
        </details>
    </div>

    <style>
        .about-btn, .upload-btn {
            padding: 10px 24px;
            font-size: 1em;
            cursor: pointer;
            background: linear-gradient(90deg, #4f8cff 0%, #38e8ff 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(79,140,255,0.15);
            transition: background 0.2s, transform 0.1s;
            text-align: center;
        }
        .about-btn:hover, .upload-btn:hover {
            background: linear-gradient(90deg, #38e8ff 0%, #4f8cff 100%);
            transform: translateY(-2px) scale(1.04);
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 18px;
            align-items: center;
            background: #f8fbff;
            border-radius: 8px;
            padding: 16px 18px 10px 18px;
            box-shadow: 0 1px 6px rgba(79,140,255,0.07);
        }
        #controls label {
            font-weight: 600;
            margin-right: 4px;
            color: #2a3b5c;
        }
        .dropdown {
            padding: 7px 14px;
            border-radius: 5px;
            border: 1px solid #b8d0ff;
            background: #fff;
            font-size: 1em;
            color: #2a3b5c;
            transition: border 0.2s;
            box-shadow: 0 1px 3px rgba(79,140,255,0.04);
        }
        .dropdown:focus {
            border: 1.5px solid #4f8cff;
            outline: none;
        }
        #param-values {
            background-color: #f4f4f4;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(79,140,255,0.07);
        }
        #param-values span { font-weight: bold; }

        #bottom-controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            z-index: 1000;
        }

        #csv-info-box {
            width: 260px;
            font-size: 0.9em;
            color: #2a3b5c;
        }
        #csv-info-box summary {
            cursor: pointer;
            font-weight: bold;
            padding: 10px 15px;
            background-color: #fdfdfd;
            border: 1px solid #e0e8ff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(79,140,255,0.1);
            list-style: none; /* Hide default marker */
            text-align: center;
        }
        #csv-info-box summary::-webkit-details-marker { display: none; } /* For Chrome/Safari */
        #csv-info-box .details-content {
            padding: 15px;
            margin-top: -5px; /* Overlap with summary border */
            background-color: #fdfdfd;
            border: 1px solid #e0e8ff;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        #csv-info-box .info-link {
            text-decoration: none;
            color: #fff;
            background-color: #5a94ff;
            padding: 8px 15px;
            border-radius: 5px;
            display: block; /* Make it a block to fill width */
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }
        #csv-info-box .info-link:hover {
            background-color: #4f8cff;
            transform: translateY(-1px);
        }
    </style>

    <script>
    const paramKeys = ['tage', 'logzsol', 'dust2', 'imf_type', 'mass', 'sfh', 'tau'];
    let allData = [];
    let currentFilteredSEDs = [];
    let photometryData = null;

    // Use consistent typing
    const fixedValues = {
        tage: [0.1, 1.0, 5.0, 10.0],
        logzsol: [-1.5, -0.5, 0.0, 0.3],
        dust2: [0.0, 0.5, 1.5, 3.0],
        imf_type: [1, 2, 3], // stored as numbers
        mass: [8.0, 9.0, 10.0, 11.0],
        sfh: [1], // assuming numeric
        tau: [0.1, 1.0, 5.0, 10.0]
    };

    // Load and parse the gzipped JSON
    fetch('https://raw.githubusercontent.com/viveikjha/viveikjha.github.io/main/sed_grid_large.json.gz')
        .then(res => res.arrayBuffer())
        .then(buf => {
            const decompressed = fflate.decompressSync(new Uint8Array(buf));
            const jsonStr = new TextDecoder().decode(decompressed);
            let parsedData = JSON.parse(jsonStr);

            if (Array.isArray(parsedData)) {
                allData = parsedData;
            } else {
                console.error("Fetched SED data is not an array. Defaulting to empty. Received:", parsedData);
                allData = [];
            }

            setupUI();
            if (allData.length > 0) {
                currentFilteredSEDs = allData.slice(0, 5);
                updatePlot(currentFilteredSEDs);
            } else {
                updatePlot([]);
                const paramValuesDiv = document.getElementById('param-values');
                if (paramValuesDiv) {
                    paramValuesDiv.innerHTML = '<p><b>SED data successfully loaded, but it appears to be empty.</b></p>';
                }
            }
        })
        .catch(err => {
            console.error("Failed to load or parse SED data:", err);
        });

    function setupUI() {
        const container = document.getElementById('controls');
        container.innerHTML = '';

        paramKeys.forEach(key => {
            const select = document.createElement('select');
            select.id = `filter-${key}`;
            select.className = 'dropdown';
            const label = document.createElement('label');
            label.textContent = `${key}: `;
            label.htmlFor = select.id;

            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All';
            select.appendChild(allOption);

            fixedValues[key].forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });

            select.addEventListener('change', applyFilters);

            container.appendChild(label);
            container.appendChild(select);
        });

        document.getElementById('photometry-upload').addEventListener('change', handleFileUpload);
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            try {
                const rows = text.trim().split('\n');
                const data = rows.map(row => row.split(',').map(parseFloat));

                photometryData = {
                    x: data.map(r => r[0]), // wavelength
                    y: data.map(r => r[1]), // flux
                    error_y: {
                        type: 'data',
                        array: data.map(r => r[2]), // fluxerr
                        visible: true
                    }
                };
                updatePlot(currentFilteredSEDs); // Re-plot with new data
            } catch (err) {
                console.error("Error parsing CSV file:", err);
                alert("Could not parse CSV file. Please ensure it has 3 columns (without headers): wavelength, flux, fluxerr.");
                photometryData = null;
            }
        };
        reader.readAsText(file);
    }

    function applyFilters() {
        let filtered = allData;

        paramKeys.forEach(key => {
            const rawVal = document.getElementById(`filter-${key}`).value;
            if (rawVal !== 'all') {
                const typedVal = typeof fixedValues[key][0] === 'number' ? parseFloat(rawVal) : rawVal;
                filtered = filtered.filter(d => {
                    const paramVal = d.params[key];
                    return Math.abs(typedVal - parseFloat(paramVal)) < 1e-4;
                });
            }
        });
        
        currentFilteredSEDs = filtered;

        if (filtered.length > 0) {
            updatePlot(filtered);
            displaySelectedParams(filtered);
        } else {
            updatePlot([]);
            document.getElementById('param-values').innerHTML =
                '<p><b>No matching SEDs found for the selected parameters.</b></p>';
        }
    }

    function updatePlot(sedEntries) {
        const traces = [];

        if (sedEntries.length > 0) {
            sedEntries.forEach(entry => {
                traces.push({
                    x: entry['wavelength'],
                    y: entry['flux'],
                    mode: 'lines',
                    line: { shape: 'hv' },
                    type: 'scatter',
                    name: paramKeys.map(k => `${k}: ${format(entry.params[k])}`).join(', ')
                });
            });
        }

        if (photometryData) {
            traces.push({
                ...photometryData,
                mode: 'markers',
                type: 'scatter',
                name: 'Uploaded Photometry',
                marker: {
                    symbol: 'o',
                    size: 10,
                    color: 'rgba(255, 0, 0, 0.7)',
                    line: { width: 1, color: 'black' }
                }
            });
        }

        const layout = {
            title: sedEntries.length > 0 ? `Showing ${sedEntries.length} SED${sedEntries.length > 1 ? 's' : ''}` : 'No SEDs to display',
            xaxis: {
                title: 'Wavelength [Ã…]',
                type: 'log',
                range: [3, 7] // Corresponds to 10^3 (1000) to 10^7 (10,000,000)
            },
            yaxis: { title: 'Flux [erg s<sup>-1</sup> cm<sup>-2</sup> Ã…<sup>-1</sup>]', type: 'log' },
            margin: { t: 30 },
            legend: { font: { size: 8 } },
            showlegend: true
        };

        Plotly.newPlot('plot', traces, layout, { responsive: true });
    }

    function format(val) {
        return typeof val === 'number' ? val.toFixed(3) : val;
    }

    function displaySelectedParams(filtered) {
        const paramValuesDiv = document.getElementById('param-values');
        if (filtered.length === 0) {
            paramValuesDiv.innerHTML = '<p><b>No matching SEDs found for the selected parameters.</b></p>';
            return;
        }

        const entry = filtered[0];
        let htmlContent = '<p><b>Selected Parameters:</b></p>';
        htmlContent += '<div style="white-space:pre;">';
        htmlContent += paramKeys.map(key => `${key}: ${format(entry.params[key])}`).join('\t');
        htmlContent += '</div>';

        paramValuesDiv.innerHTML = htmlContent;
    }
    </script>
</body>
</html>
