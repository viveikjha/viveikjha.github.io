<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accessible Responsive Gallery + Carousel</title>
  <meta name="description" content="A fast, accessible, responsive image gallery with filtering, a lightbox, and a featured image carousel." />
  <style>
    :root{
      --bg: #0b0d10;
      --panel: #12161a;
      --text: #e8eef4;
      --muted: #9fb1c1;
      --accent: #4cc2ff;
      --accent-2: #8a7dff;
      --ring: #7dd3fc;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: radial-gradient(1200px 600px at 100% 0%, rgba(140,105,255,0.15), transparent 60%),
                  radial-gradient(900px 500px at 0% 100%, rgba(76,194,255,0.18), transparent 60%), var(--bg);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .container{
      width: min(1100px, 92vw);
      margin-inline: auto;
    }

    .site-header{
      padding: 40px 0 10px;
    }
    .site-title{
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.3px;
    }
    .site-tagline{
      margin: 6px 0 0;
      color: var(--muted);
    }

    /* Carousel */
    .carousel{
      margin: 18px 0 6px;
      border-radius: var(--radius);
      overflow: clip;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow);
      position: relative;
    }
    .carousel__viewport{
      overflow: hidden;
    }
    .carousel__track{
      display: flex;
      will-change: transform;
      transition: transform 400ms ease;
      touch-action: pan-y;
    }
    .carousel__slide{
      position: relative;
      min-width: 100%;
      aspect-ratio: 16 / 9;
      background: #0d1216;
      display: grid;
      place-items: center;
      user-select: none;
    }
    .carousel__img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.02);
    }
    .carousel__caption{
      position: absolute;
      left: 12px; right: 12px; bottom: 12px;
      padding: 8px 12px;
      font-size: 0.95rem;
      color: var(--text);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(3px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }
    .carousel__controls{
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      pointer-events: none;
    }
    .carousel__btn{
      pointer-events: auto;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.25);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .carousel__btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(125,211,252,0.55);
    }
    .carousel__btn--prev{ justify-self: start; margin-left: 10px; }
    .carousel__btn--next{ justify-self: end; margin-right: 10px; }
    .carousel__btn--toggle{
      position: absolute;
      right: 10px;
      top: 10px;
      pointer-events: auto;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.25);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .carousel__dots{
      position: absolute;
      bottom: 10px;
      left: 0; right: 0;
      display: flex;
      gap: 8px;
      justify-content: center;
      pointer-events: auto;
    }
    .carousel__dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(255,255,255,0.6);
      cursor: pointer;
      padding: 0;
    }
    .carousel__dot[aria-pressed="true"]{
      background: linear-gradient(180deg, rgba(140,105,255,0.9), rgba(140,105,255,0.6));
      border-color: rgba(141,125,255,0.95);
      box-shadow: 0 0 0 3px rgba(125,211,252,0.35);
    }

    /* Controls + Search */
    .controls{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 18px 0 10px;
    }
    .filters{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .filter-btn{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
    }
    .filter-btn.is-active{
      background: linear-gradient(180deg, rgba(140,105,255,0.25), rgba(140,105,255,0.08));
      border-color: rgba(141,125,255,0.6);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 0 0 3px rgba(125,211,252,0.25);
    }
    .filter-btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(125,211,252,0.55);
    }

    .search input{
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .search input::placeholder{ color: #7b8a98; }
    .search input:focus{
      outline: none;
      border-color: rgba(125,211,252,0.6);
      box-shadow: 0 0 0 3px rgba(125,211,252,0.35);
    }

    /* Gallery Grid */
    .gallery{
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      padding: 18px 0 48px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius);
      overflow: clip;
      box-shadow: var(--shadow);
      transition: transform 140ms ease, box-shadow 140ms ease;
    }
    .card:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(125,211,252,0.55), var(--shadow);
    }
    .card:hover{
      transform: translateY(-2px);
    }
    .card__btn{
      appearance: none;
      border: 0;
      margin: 0;
      padding: 0;
      width: 100%;
      background: transparent;
      color: inherit;
      cursor: pointer;
      text-align: left;
    }
    .card__media{
      position: relative;
      aspect-ratio: 4 / 3;
      background: #0d1216;
    }
    .card__img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(1.02);
    }
    .card__meta{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      gap: 10px;
    }
    .card__title{
      margin: 0;
      font-size: 0.98rem;
      line-height: 1.2;
    }
    .card__badge{
      font-size: 0.75rem;
      color: var(--muted);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .empty-state{
      color: var(--muted);
      text-align: center;
      padding: 40px 0 80px;
    }

    /* Lightbox */
    .lightbox{
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 140ms ease;
      z-index: 1000;
    }
    .lightbox[aria-hidden="false"]{
      opacity: 1;
      pointer-events: auto;
    }
    .lightbox__backdrop{
      position: absolute;
      inset: 0;
    }
    .lightbox__body{
      position: relative;
      width: min(1000px, 92vw);
      max-height: 90vh;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-rows: auto 1fr auto;
      overflow: hidden;
    }

    .lightbox__header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(0,0,0,0.25);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .lightbox__title{
      margin: 0;
      font-size: 1rem;
      color: var(--muted);
    }
    .icon-btn{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: var(--text);
      padding: 6px 10px;
      cursor: pointer;
    }
    .icon-btn:focus-visible{ outline: none; box-shadow: 0 0 0 3px rgba(125,211,252,0.55); }

    .lightbox__figure{
      margin: 0;
      display: grid;
      grid-template-rows: 1fr auto;
      align-items: center;
      min-height: 0;
    }
    .lightbox__figure img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #0b0f13;
    }
    .lightbox__caption{
      padding: 10px 12px;
      color: var(--muted);
      border-top: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.2);
    }

    .lightbox__controls{
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      padding: 10px 12px 12px;
      background: rgba(0,0,0,0.25);
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .pill-btn{
      justify-self: start;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--text);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
    }
    .pill-btn:last-child{ justify-self: end; }
    .pill-btn:focus-visible{ outline: none; box-shadow: 0 0 0 3px rgba(125,211,252,0.55); }

    .lightbox__counter{
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }

    .visually-hidden{
      position: absolute !important;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 1px, 1px);
      white-space: nowrap; border: 0;
    }

    @media (min-width: 768px){
      .controls{
        grid-template-columns: 1fr auto;
        align-items: center;
      }
    }

    @media (prefers-reduced-motion: reduce){
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">Gallery</h1>
      <p class="site-tagline">Featured carousel, JSON-powered grid, and a keyboard-friendly lightbox.</p>
    </div>
  </header>

  <main id="main" class="container" aria-live="polite">
    <!-- Carousel -->
    <section class="carousel" aria-roledescription="carousel" aria-label="Featured images carousel">
      <button type="button" class="carousel__btn carousel__btn--toggle" id="crslToggle" aria-pressed="true" aria-label="Pause autoplay">⏸</button>
      <div class="carousel__viewport" id="carouselViewport">
        <div class="carousel__track" id="carouselTrack" style="transform: translateX(0%)">
          <!-- Slides injected by JS -->
        </div>
      </div>
      <div class="carousel__controls" aria-hidden="false">
        <button type="button" class="carousel__btn carousel__btn--prev" id="crslPrev" aria-label="Previous slide (←)">←</button>
        <div></div>
        <button type="button" class="carousel__btn carousel__btn--next" id="crslNext" aria-label="Next slide (→)">→</button>
      </div>
      <div class="carousel__dots" id="carouselDots" role="tablist" aria-label="Slide navigation">
        <!-- Dots injected by JS -->
      </div>
    </section>

    <!-- Controls -->
    <section class="controls" aria-label="Gallery controls">
      <div class="filters" role="toolbar" aria-label="Category filters">
        <button type="button" class="filter-btn is-active" data-filter="all" aria-pressed="true">All</button>
      </div>
      <label class="search">
        <span class="visually-hidden">Search images</span>
        <input id="search" type="search" inputmode="search" placeholder="Search by filename…" aria-label="Search images" />
      </label>
    </section>

    <!-- Gallery -->
    <section aria-label="Image gallery">
      <div id="gallery" class="gallery" role="list"></div>
      <div id="empty-state" class="empty-state" hidden>No images match your filters.</div>
    </section>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-labelledby="lightbox-title" aria-hidden="true">
    <div class="lightbox__backdrop" data-backdrop></div>
    <div class="lightbox__body" role="document">
      <header class="lightbox__header">
        <h2 id="lightbox-title" class="lightbox__title">Image preview</h2>
        <button type="button" class="icon-btn" id="btnClose" aria-label="Close (Esc)">
          <span aria-hidden="true">✕</span>
        </button>
      </header>
      <figure class="lightbox__figure">
        <img id="lightboxImg" alt="" />
        <figcaption id="lightboxCaption" class="lightbox__caption"></figcaption>
      </figure>
      <div class="lightbox__controls">
        <button type="button" class="pill-btn" id="btnPrev" aria-label="Previous (←)">
          <span aria-hidden="true">← Prev</span>
        </button>
        <span id="lightboxCounter" class="lightbox__counter" aria-live="polite"></span>
        <button type="button" class="pill-btn" id="btnNext" aria-label="Next (→)">
          <span aria-hidden="true">Next →</span>
        </button>
      </div>
    </div>
  </div>

  <noscript>
    <div class="container">
      JavaScript is disabled; the lightbox, search, and carousel won’t work. Enable JavaScript for the best experience.
    </div>
  </noscript>

  <script>
    "use strict";

    // ------------ Data (loaded from images.json) ------------
    let CAROUSEL = []; // built from first N images
    let IMAGES = [];   // built from images.json

    // ------------ Elements ------------
    const el = {
      // Gallery
      gallery: document.getElementById("gallery"),
      empty: document.getElementById("empty-state"),
      search: document.getElementById("search"),
      filterButtons: Array.from(document.querySelectorAll(".filter-btn")),
      main: document.getElementById("main"),
      lightbox: document.getElementById("lightbox"),
      lbImg: document.getElementById("lightboxImg"),
      lbCaption: document.getElementById("lightboxCaption"),
      lbCounter: document.getElementById("lightboxCounter"),
      btnPrev: document.getElementById("btnPrev"),
      btnNext: document.getElementById("btnNext"),
      btnClose: document.getElementById("btnClose"),
      // Carousel
      crslTrack: document.getElementById("carouselTrack"),
      crslPrev: document.getElementById("crslPrev"),
      crslNext: document.getElementById("crslNext"),
      crslDots: document.getElementById("carouselDots"),
      crslToggle: document.getElementById("crslToggle"),
      crslViewport: document.getElementById("carouselViewport"),
    };

    // ------------ Helpers ------------
    function filenameToItem(filename, i){
      const dot = filename.lastIndexOf(".");
      const ext = dot >= 0 ? filename.slice(dot) : "";
      const base = dot >= 0 ? filename.slice(0, dot) : filename;
      const title = base.replace(/[_-]+/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      return {
        id: i,
        title,
        category: "gallery",
        thumb: `gallery/thumbnails/${base}_thumb${ext}`,
        full: `gallery/${filename}`,
      };
    }

    // ------------ Gallery State ------------
    let state = {
      category: "all",
      query: "",
      visible: [],
      currentIndexInVisible: 0,
      lastFocus: null,
    };

    function normalize(str){ return (str || "").toLowerCase().trim(); }

    function applyFilters(){
      const q = normalize(state.query);
      const cat = state.category;
      const out = [];
      for (let i=0; i<IMAGES.length; i++){
        const it = IMAGES[i];
        if (cat !== "all" && it.category !== cat) continue;
        if (q && !(normalize(it.title).includes(q))) continue;
        out.push(i);
      }
      state.visible = out;
    }

    function renderGallery(){
      applyFilters();
      el.gallery.innerHTML = "";
      if (state.visible.length === 0){
        el.empty.hidden = false;
        return;
      }
      el.empty.hidden = true;
      const frag = document.createDocumentFragment();

      for (let pos=0; pos<state.visible.length; pos++){
        const i = state.visible[pos];
        const item = IMAGES[i];

        const card = document.createElement("div");
        card.className = "card";
        card.role = "listitem";

        const btn = document.createElement("button");
        btn.className = "card__btn";
        btn.type = "button";
        btn.setAttribute("aria-label", `${item.title}`);
        btn.dataset.pos = String(pos);

        const media = document.createElement("div");
        media.className = "card__media";

        const img = document.createElement("img");
        img.className = "card__img";
        img.src = item.thumb;
        img.alt = item.title;
        img.loading = "lazy";
        img.decoding = "async";
        img.sizes = "(max-width: 600px) 100vw, (max-width: 1100px) 33vw, 300px";
        img.onerror = () => { img.onerror = null; img.src = item.full; };

        media.appendChild(img);

        const meta = document.createElement("div");
        meta.className = "card__meta";

        const h = document.createElement("h3");
        h.className = "card__title";
        h.textContent = item.title;

        const badge = document.createElement("span");
        badge.className = "card__badge";
        badge.textContent = "gallery";

        meta.append(h, badge);
        btn.append(media, meta);
        card.append(btn);
        frag.append(card);
      }

      el.gallery.append(frag);
    }

    function setActiveFilterButton(){
      for (const b of el.filterButtons){
        const isActive = b.dataset.filter === state.category;
        b.classList.toggle("is-active", isActive);
        b.setAttribute("aria-pressed", String(isActive));
      }
    }

    function onFilterClick(e){
      const btn = e.target.closest(".filter-btn");
      if (!btn) return;
      const newCat = btn.dataset.filter || "all";
      if (state.category === newCat) return;
      state.category = newCat;
      setActiveFilterButton();
      renderGallery();
    }

    function onSearchInput(e){
      state.query = e.target.value || "";
      renderGallery();
    }

    // ------------ Lightbox ------------
    function openLightbox(pos){
      state.currentIndexInVisible = pos;
      updateLightboxContent();
      state.lastFocus = document.activeElement;
      el.main.setAttribute("aria-hidden", "true");
      try { el.main.inert = true; } catch {}
      el.lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      el.btnClose.focus();

      window.addEventListener("keydown", onLightboxKeydown);
      el.btnPrev.addEventListener("click", onPrev);
      el.btnNext.addEventListener("click", onNext);
      el.btnClose.addEventListener("click", closeLightbox);
      el.lightbox.addEventListener("click", onBackdropClick);
    }

    function closeLightbox(){
      el.lightbox.setAttribute("aria-hidden", "true");
      el.main.removeAttribute("aria-hidden");
      try { el.main.inert = false; } catch {}
      document.body.style.overflow = "";
      if (state.lastFocus && typeof state.lastFocus.focus === "function"){
        state.lastFocus.focus();
      }
      window.removeEventListener("keydown", onLightboxKeydown);
      el.btnPrev.removeEventListener("click", onPrev);
      el.btnNext.removeEventListener("click", onNext);
      el.btnClose.removeEventListener("click", closeLightbox);
      el.lightbox.removeEventListener("click", onBackdropClick);
    }

    function onBackdropClick(e){
      if (e.target && e.target.hasAttribute("data-backdrop")){
        closeLightbox();
      }
    }

    function onPrev(){
      if (state.visible.length === 0) return;
      state.currentIndexInVisible = (state.currentIndexInVisible - 1 + state.visible.length) % state.visible.length;
      updateLightboxContent(true);
    }
    function onNext(){
      if (state.visible.length === 0) return;
      state.currentIndexInVisible = (state.currentIndexInVisible + 1) % state.visible.length;
      updateLightboxContent(true);
    }

    function onLightboxKeydown(e){
      if (e.key === "Escape") { e.preventDefault(); closeLightbox(); }
      else if (e.key === "ArrowLeft") { e.preventDefault(); onPrev(); }
      else if (e.key === "ArrowRight") { e.preventDefault(); onNext(); }
      else if (e.key === "Tab") {
        const focusables = el.lightbox.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (focusables.length === 0) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first){
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
      }
    }

    function updateLightboxContent(preloadNeighbors=false){
      const globalIndex = state.visible[state.currentIndexInVisible];
      const item = IMAGES[globalIndex];
      if (!item) return;
      el.lbCaption.textContent = `${item.title}`;
      el.lbCounter.textContent = `${state.currentIndexInVisible + 1} / ${state.visible.length}`;

      const temp = new Image();
      temp.alt = item.title;
      temp.onload = () => {
        el.lbImg.src = temp.src;
        el.lbImg.alt = item.title;
      };
      temp.src = item.full;

      if (preloadNeighbors && state.visible.length > 1){
        const prevIdx = state.visible[(state.currentIndexInVisible - 1 + state.visible.length) % state.visible.length];
        const nextIdx = state.visible[(state.currentIndexInVisible + 1) % state.visible.length];
        [prevIdx, nextIdx].forEach(i => {
          const p = new Image();
          if (IMAGES[i]) p.src = IMAGES[i].full;
        });
      }
    }

    // Event delegation for gallery clicks
    el.gallery.addEventListener("click", (e) => {
      const btn = e.target.closest(".card__btn");
      if (!btn) return;
      const pos = Number(btn.dataset.pos || 0);
      openLightbox(pos);
    });

    // Wire up filters and search
    document.querySelector(".filters").addEventListener("click", onFilterClick);
    el.search.addEventListener("input", onSearchInput);

    // ------------ Carousel ------------
    const prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const AUTOPLAY_MS = 4000;
    let currentSlide = 0;
    let crslTimer = null;
    let isAutoplay = !prefersReducedMotion;
    let isPointerDown = false;
    let startX = 0;
    let deltaX = 0;

    function renderCarousel(){
      el.crslTrack.innerHTML = "";
      const frag = document.createDocumentFragment();
      CAROUSEL.forEach((item, idx) => {
        const slide = document.createElement("div");
        slide.className = "carousel__slide";
        slide.setAttribute("role", "group");
        slide.setAttribute("aria-roledescription", "slide");
        slide.setAttribute("aria-label", `${idx + 1} of ${CAROUSEL.length}`);
        slide.setAttribute("aria-hidden", idx === currentSlide ? "false" : "true");
        if (idx !== currentSlide) {
          try { slide.inert = true; } catch {}
        }

        const img = document.createElement("img");
        img.className = "carousel__img";
        img.src = item.full;
        img.alt = item.title;
        img.decoding = "async";

        const cap = document.createElement("div");
        cap.className = "carousel__caption";
        cap.textContent = item.title;

        slide.append(img, cap);
        frag.append(slide);
      });
      el.crslTrack.append(frag);

      // Dots
      el.crslDots.innerHTML = "";
      CAROUSEL.forEach((_, idx) => {
        const dot = document.createElement("button");
        dot.className = "carousel__dot";
        dot.type = "button";
        dot.setAttribute("role", "tab");
        dot.setAttribute("aria-label", `Go to slide ${idx + 1}`);
        dot.setAttribute("aria-pressed", String(idx === currentSlide));
        dot.dataset.index = String(idx);
        el.crslDots.append(dot);
      });

      updateCarouselTransform();
    }

    function updateCarouselTransform(){
      const pct = -100 * currentSlide;
      el.crslTrack.style.transform = `translateX(${pct}%)`;
      const slides = Array.from(el.crslTrack.children);
      slides.forEach((s, idx) => {
        s.setAttribute("aria-hidden", idx === currentSlide ? "false" : "true");
        if (idx === currentSlide) { try { s.inert = false; } catch {} }
        else { try { s.inert = true; } catch {} }
      });
      Array.from(el.crslDots.children).forEach((d, idx) => {
        d.setAttribute("aria-pressed", String(idx === currentSlide));
      });
    }

    function goToSlide(idx){
      if (!CAROUSEL.length) return;
      currentSlide = (idx + CAROUSEL.length) % CAROUSEL.length;
      updateCarouselTransform();
    }

    function nextSlide(){ goToSlide(currentSlide + 1); }
    function prevSlide(){ goToSlide(currentSlide - 1); }

    function startAutoplay(){
      clearInterval(crslTimer);
      if (!isAutoplay || CAROUSEL.length <= 1) return;
      crslTimer = setInterval(() => { nextSlide(); }, AUTOPLAY_MS);
      el.crslToggle.setAttribute("aria-pressed", "true");
      el.crslToggle.setAttribute("aria-label", "Pause autoplay");
      el.crslToggle.textContent = "⏸";
    }

    function stopAutoplay(){
      clearInterval(crslTimer);
      crslTimer = null;
      el.crslToggle.setAttribute("aria-pressed", "false");
      el.crslToggle.setAttribute("aria-label", "Play autoplay");
      el.crslToggle.textContent = "▶";
    }

    function toggleAutoplay(){
      isAutoplay = !isAutoplay;
      if (isAutoplay) startAutoplay();
      else stopAutoplay();
    }

    // Pointer (swipe) handling
    function onPointerDown(e){
      if (!CAROUSEL.length) return;
      isPointerDown = true;
      startX = e.clientX ?? e.touches?.[0]?.clientX ?? 0;
      deltaX = 0;
      el.crslTrack.style.transition = "none";
      stopAutoplay();
    }
    function onPointerMove(e){
      if (!isPointerDown) return;
      const x = e.clientX ?? e.touches?.[0]?.clientX ?? 0;
      deltaX = x - startX;
      const width = el.crslViewport.clientWidth || 1;
      const offsetPct = (-100 * currentSlide) + (deltaX / width) * 100;
      el.crslTrack.style.transform = `translateX(${offsetPct}%)`;
    }
    function onPointerUp(){
      if (!isPointerDown) return;
      isPointerDown = false;
      el.crslTrack.style.transition = "";
      const width = el.crslViewport.clientWidth || 1;
      const threshold = width * 0.2;
      if (Math.abs(deltaX) > threshold){
        if (deltaX < 0) nextSlide();
        else prevSlide();
      } else {
        updateCarouselTransform();
      }
      if (isAutoplay) startAutoplay();
    }

    // Keyboard for carousel
    function onCarouselKey(e){
      if (e.key === "ArrowLeft"){ e.preventDefault(); stopAutoplay(); prevSlide(); }
      else if (e.key === "ArrowRight"){ e.preventDefault(); stopAutoplay(); nextSlide(); }
    }

    // Hover/focus pause
    function onHoverIn(){ if (crslTimer){ stopAutoplay(); } }
    function onHoverOut(){ if (isAutoplay){ startAutoplay(); } }

    // Events (can wire early)
    el.crslPrev.addEventListener("click", () => { stopAutoplay(); prevSlide(); });
    el.crslNext.addEventListener("click", () => { stopAutoplay(); nextSlide(); });
    el.crslDots.addEventListener("click", (e) => {
      const btn = e.target.closest(".carousel__dot");
      if (!btn) return;
      const idx = Number(btn.dataset.index || 0);
      stopAutoplay();
      goToSlide(idx);
    });
    el.crslToggle.addEventListener("click", toggleAutoplay);

    // Pointer/touch
    el.crslViewport.addEventListener("pointerdown", onPointerDown);
    window.addEventListener("pointermove", onPointerMove);
    window.addEventListener("pointerup", onPointerUp);
    el.crslViewport.addEventListener("touchstart", onPointerDown, { passive: true });
    window.addEventListener("touchmove", onPointerMove, { passive: true });
    window.addEventListener("touchend", onPointerUp);

    // Keyboard
    el.crslViewport.addEventListener("keydown", onCarouselKey);
    el.crslViewport.tabIndex = 0;

    // Hover pause
    el.crslViewport.addEventListener("mouseenter", onHoverIn);
    el.crslViewport.addEventListener("mouseleave", onHoverOut);

    // Visibility change (pause when tab hidden)
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopAutoplay();
      else if (isAutoplay) startAutoplay();
    });

    // ------------ Load images from images.json and boot ------------
    async function loadImages(){
      try{
        const res = await fetch("images.json");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const files = await res.json(); // array of filenames
        IMAGES = files.map((f, i) => filenameToItem(f, i));

        // Build carousel from first 6 images (or fewer)
        CAROUSEL = IMAGES.slice(0, 6);

        // Initial renders
        setActiveFilterButton();
        renderGallery();
        renderCarousel();
        if (isAutoplay) startAutoplay();
      } catch(err){
        console.error("Error fetching images:", err);
        el.empty.hidden = false;
        el.empty.textContent = "Error loading images.";
      }
    }

    loadImages();
  </script>
</body>
</html>
